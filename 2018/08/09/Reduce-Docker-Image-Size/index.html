<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="In my previous blog, I proposed a way to easily run large scale machine learning task in cloud using Docker container and Azure Batch. I also use this approach at work for some of my projects. One thi">
<meta property="og:type" content="article">
<meta property="og:title" content="Reduce Docker Image Size for Machine Learning">
<meta property="og:url" content="http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/index.html">
<meta property="og:site_name" content="The Little&#39;s Place">
<meta property="og:description" content="In my previous blog, I proposed a way to easily run large scale machine learning task in cloud using Docker container and Azure Batch. I also use this approach at work for some of my projects. One thi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-08-09T00:00:00.000Z">
<meta property="article:modified_time" content="2021-01-10T05:51:39.893Z">
<meta property="article:author" content="Jilong Liao">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Reduce Docker Image Size for Machine Learning</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/little-eyes" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/10/12/Azure-App-Service_Authentication/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/05/28/container-ml-azure-batch/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&text=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&is_video=false&description=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Reduce Docker Image Size for Machine Learning&body=Check out this article: http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&name=Reduce Docker Image Size for Machine Learning&description=&lt;p&gt;In my &lt;a href=&#34;https://jilongliao.com/2018/05/28/container-ml-azure-batch/&#34;&gt;previous blog&lt;/a&gt;, I proposed a way to easily run large scale machine learning task in cloud using Docker container and Azure Batch. I also use this approach at work for some of my projects. One thing I start realizing is the size of the contianer image can grow very quickly as we add more functionality into the ML training task.&lt;/p&gt;
&lt;p&gt;Use open source tools such as scikit-learn, nltk etc. will bring additional dependencies into the container image. For example, some of us may use &lt;a href=&#34;https://conda.io/miniconda.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mini conda&lt;/a&gt;, but it can easily introduce a few hundred MBs into the docker container image. The Ubuntu 16.04 base image is about 120MB, then very quickly I start seeing my container image size go beyond 1GB, then 3GB after install some other tools.&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reduce-Layers"><span class="toc-number">1.</span> <span class="toc-text">Reduce Layers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Remove-Uncessary-Dependencies"><span class="toc-number">2.</span> <span class="toc-text">Remove Uncessary Dependencies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Go-Beyond-1GB"><span class="toc-number">3.</span> <span class="toc-text">Go Beyond 1GB</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Reduce Docker Image Size for Machine Learning
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">The Little's Place</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2018-08-09T00:00:00.000Z" itemprop="datePublished">2018-08-09</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/technology/">technology</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Docker/" rel="tag">Docker</a>, <a class="tag-link" href="/tags/Machine-Learning/" rel="tag">Machine Learning</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>In my <a href="https://jilongliao.com/2018/05/28/container-ml-azure-batch/">previous blog</a>, I proposed a way to easily run large scale machine learning task in cloud using Docker container and Azure Batch. I also use this approach at work for some of my projects. One thing I start realizing is the size of the contianer image can grow very quickly as we add more functionality into the ML training task.</p>
<p>Use open source tools such as scikit-learn, nltk etc. will bring additional dependencies into the container image. For example, some of us may use <a href="https://conda.io/miniconda.html" target="_blank" rel="noopener">mini conda</a>, but it can easily introduce a few hundred MBs into the docker container image. The Ubuntu 16.04 base image is about 120MB, then very quickly I start seeing my container image size go beyond 1GB, then 3GB after install some other tools.</p>
<a id="more"></a>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y cmake build-essential gcc g++ git wget libgl1-mesa-glx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true"</span> | debconf-set-selections</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y --no-install-recommends msttcorefonts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python-package</span></span><br><span class="line"><span class="comment"># miniconda</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /bin/bash Miniconda3-latest-Linux-x86_64.sh -f -b -p /opt/conda &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">export</span> PATH=<span class="string">"/opt/conda/bin:<span class="variable">$PATH</span>"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH /opt/conda/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> conda install -y numpy scipy scikit-learn pandas matplotlib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># azure storage</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install azure azure-storage</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lightgbm</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> --recursive https://github.com/Microsoft/LightGBM &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> LightGBM/python-package &amp;&amp; python setup.py install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clean</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get autoremove -y &amp;&amp; apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    conda clean -i -l -t -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /usr/<span class="built_in">local</span>/src/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy resource files</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ACR_KEY=<span class="string">"[ACR_KEY]"</span></span><br><span class="line"><span class="keyword">ENV</span> AZURE_BLOB_KEY=<span class="string">"[AZURE_BLOB_KEY]"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [ <span class="string">"python"</span>, <span class="string">"cloud.py"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>Azure Batch’s starting task gets longer and longer because it needs signifcantly more time to pull the image of 3G than a few MBs. Therefore, I decided to reduce the container image size.</p>
<h2 id="Reduce-Layers"><a href="#Reduce-Layers" class="headerlink" title="Reduce Layers"></a>Reduce Layers</h2><p>The first try is to reduce layers in the Dockerfile above. For example, combine those <code>RUN</code> command together could reduce a lot of layers which leads to smaller container size. But the size is still 2.x GB. What’s next?</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y cmake build-essential gcc g++ git wget libgl1-mesa-glx &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">"ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true"</span> | debconf-set-selections &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y --no-install-recommends msttcorefonts &amp;&amp; \</span></span><br><span class="line"><span class="bash">    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /bin/bash Miniconda3-latest-Linux-x86_64.sh -f -b -p /opt/conda &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">export</span> PATH=<span class="string">"/opt/conda/bin:<span class="variable">$PATH</span>"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH /opt/conda/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> conda install -y numpy scipy scikit-learn pandas matplotlib &amp;&amp; \</span></span><br><span class="line"><span class="bash">    pip install azure azure-storage &amp;&amp; \</span></span><br><span class="line"><span class="bash">    git <span class="built_in">clone</span> --recursive https://github.com/Microsoft/LightGBM &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> LightGBM/python-package &amp;&amp; python setup.py install &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get autoremove -y &amp;&amp; apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    conda clean -i -l -t -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /usr/<span class="built_in">local</span>/src/*</span></span><br></pre></td></tr></table></figure>

<h2 id="Remove-Uncessary-Dependencies"><a href="#Remove-Uncessary-Dependencies" class="headerlink" title="Remove Uncessary Dependencies"></a>Remove Uncessary Dependencies</h2><p>The Dockerfile above install mini conda, but eseentially we only use the standard Python library plus numpy, scipy etc. in the <code>conda install</code> command. Obviously, this is a big chunk to remove. So we decided to use a Python base image from Debian. This save us about 1GB of space and the image size is now 1.3GB. In this round, we will have to specify which version of numpy, scipy etc. runs because some newer version, such as numpy 1.14.3 is not compatible with matplotlib at runtime. Though this brings challenge to debug and match the right version, while mini conda does this for you, it still worth the effort of reducing 1GB of the size.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>.<span class="number">6</span>-slim-stretch</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y --no-install-recommends libatlas-base-dev gfortran cmake build-essential git tk \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb http://httpredir.debian.org/debian jessie main contrib"</span> &gt; /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb http://security.debian.org/ jessie/updates main contrib"</span> &gt;&gt; /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true"</span> | debconf-set-selections \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y --no-install-recommends ttf-mscorefonts-installer \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get clean \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get autoremove -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install --no-cache-dir \</span></span><br><span class="line"><span class="bash">    numpy==1.14.2 \</span></span><br><span class="line"><span class="bash">    scipy==1.0.1 \</span></span><br><span class="line"><span class="bash">    scikit-learn==0.19.1 \</span></span><br><span class="line"><span class="bash">    pandas==0.22.0 \</span></span><br><span class="line"><span class="bash">    matplotlib==2.2.2 \</span></span><br><span class="line"><span class="bash">    azure \</span></span><br><span class="line"><span class="bash">    azure-storage==0.36.0 \</span></span><br><span class="line"><span class="bash">    py-multibase==0.1.2 \</span></span><br><span class="line"><span class="bash">    wheel \</span></span><br><span class="line"><span class="bash">    lightgbm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lightgbm</span></span><br><span class="line"><span class="comment"># RUN git clone --recursive https://github.com/Microsoft/LightGBM &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     cd LightGBM/python-package &amp;&amp; python setup.py install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clean</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get autoremove -y &amp;&amp; apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    rm -rf /usr/<span class="built_in">local</span>/src/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy resource files</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ACR_KEY=<span class="string">"[ACR_KEY]"</span></span><br><span class="line"><span class="keyword">ENV</span> AZURE_BLOB_KEY=<span class="string">"[AZURE_BLOB_KEY]"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [ <span class="string">"python"</span>, <span class="string">"cloud.py"</span> ]</span></span><br></pre></td></tr></table></figure>

<h2 id="Go-Beyond-1GB"><a href="#Go-Beyond-1GB" class="headerlink" title="Go Beyond 1GB"></a>Go Beyond 1GB</h2><p>At this point, I only install the libs I really need at runtime so it reaches a minimal point of image size. But I still wonder if I can break the 1GB limit. There is a way! <a href="https://alpinelinux.org/" target="_blank" rel="noopener">Alpine Linux Project</a> offers a 5MB bare minimal linux environment to start with. Yes, it is 5mb, comparing to 115MB ubuntu image. Python also has a base image for alpine <code>python:3.6-alpine</code> which is 75MB, comparing to 918MB of Ubuntu Python image. If I can use Alpine Linux, I am reducing another big chunk. </p>
<p>Since Alpine linux has its own package management system, it took me some time to satisfy all the dependencies to build and install all my dependencies and make LightGBM running the same as Ubuntu container. Now the size is 834MB. This blog’s effort saves 2.5GB overhead for Azure Batch’s starting task of pulling container images.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update &amp;&amp; \</span></span><br><span class="line"><span class="bash">	apk add --no-cache \</span></span><br><span class="line"><span class="bash">    <span class="comment"># bash \</span></span></span><br><span class="line"><span class="bash">    libstdc++ \</span></span><br><span class="line"><span class="bash">    libgomp \</span></span><br><span class="line"><span class="bash">    build-base \</span></span><br><span class="line"><span class="bash">    cmake \</span></span><br><span class="line"><span class="bash">    gfortran \</span></span><br><span class="line"><span class="bash">    libpng &amp;&amp; \</span></span><br><span class="line"><span class="bash">    ln -s locale.h /usr/include/xlocale.h &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apk add --no-cache --virtual .build-deps \</span></span><br><span class="line"><span class="bash">    lapack-dev \</span></span><br><span class="line"><span class="bash">    musl-dev \</span></span><br><span class="line"><span class="bash">    python3-dev \</span></span><br><span class="line"><span class="bash">    jpeg-dev \</span></span><br><span class="line"><span class="bash">    freetype-dev \</span></span><br><span class="line"><span class="bash">    libffi-dev \</span></span><br><span class="line"><span class="bash">    openssl-dev \</span></span><br><span class="line"><span class="bash">    g++ &amp;&amp; \</span></span><br><span class="line"><span class="bash">    pip install --no-cache-dir \</span></span><br><span class="line"><span class="bash">    numpy==1.14.2 \</span></span><br><span class="line"><span class="bash">    scipy==1.0.1 \</span></span><br><span class="line"><span class="bash">    scikit-learn==0.19.1 \</span></span><br><span class="line"><span class="bash">    pandas==0.22.0 \</span></span><br><span class="line"><span class="bash">    matplotlib==2.2.2 \</span></span><br><span class="line"><span class="bash">    azure-storage==0.36.0 \</span></span><br><span class="line"><span class="bash">    py-multibase==0.1.2 \</span></span><br><span class="line"><span class="bash">    wheel \</span></span><br><span class="line"><span class="bash">    lightgbm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN apk del .build-deps</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ACR_KEY=<span class="string">"[ACR_KEY]"</span></span><br><span class="line"><span class="keyword">ENV</span> AZURE_BLOB_KEY=<span class="string">"[AZURE_BLOB_KEY]"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [ <span class="string">"python"</span>, <span class="string">"cloud.py"</span> ]</span></span><br></pre></td></tr></table></figure>


  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/little-eyes" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reduce-Layers"><span class="toc-number">1.</span> <span class="toc-text">Reduce Layers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Remove-Uncessary-Dependencies"><span class="toc-number">2.</span> <span class="toc-text">Remove Uncessary Dependencies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Go-Beyond-1GB"><span class="toc-number">3.</span> <span class="toc-text">Go Beyond 1GB</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&text=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&is_video=false&description=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Reduce Docker Image Size for Machine Learning&body=Check out this article: http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&title=Reduce Docker Image Size for Machine Learning" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://jilongliao.com/2018/08/09/Reduce-Docker-Image-Size/&name=Reduce Docker Image Size for Machine Learning&description=&lt;p&gt;In my &lt;a href=&#34;https://jilongliao.com/2018/05/28/container-ml-azure-batch/&#34;&gt;previous blog&lt;/a&gt;, I proposed a way to easily run large scale machine learning task in cloud using Docker container and Azure Batch. I also use this approach at work for some of my projects. One thing I start realizing is the size of the contianer image can grow very quickly as we add more functionality into the ML training task.&lt;/p&gt;
&lt;p&gt;Use open source tools such as scikit-learn, nltk etc. will bring additional dependencies into the container image. For example, some of us may use &lt;a href=&#34;https://conda.io/miniconda.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mini conda&lt;/a&gt;, but it can easily introduce a few hundred MBs into the docker container image. The Ubuntu 16.04 base image is about 120MB, then very quickly I start seeing my container image size go beyond 1GB, then 3GB after install some other tools.&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 Jilong Liao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/little-eyes" target="_blank" rel="noopener">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-32402817-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'littleeyes';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
